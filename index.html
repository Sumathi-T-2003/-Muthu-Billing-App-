<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUTHU MOBILES | Tax Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --red: #D32F2F; --black: #000000; --gray: #f2f2f2; }
        body { font-family: 'Arial', sans-serif; background: #d1d5db; margin: 0; padding: 20px; color: #000; }
        
        /* Main Invoice Sheet */
        .bill-book { 
            max-width: 800px; margin: auto; background: white; padding: 40px; 
            border: 2px solid #000; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }

        .tax-top { text-align: right; font-size: 11px; font-weight: bold; text-transform: uppercase; margin-bottom: 5px; }
        
        /* Header Section */
        .header-main { display: flex; justify-content: space-between; border-bottom: 4px solid var(--red); padding-bottom: 15px; margin-bottom: 20px; }
        .shop-details h1 { color: var(--red); margin: 0; font-size: 35px; font-weight: 900; letter-spacing: -1px; }
        .shop-details p { font-size: 13px; margin: 2px 0; font-weight: 600; }

        .bill-info { text-align: right; font-size: 14px; font-weight: bold; }
        .bill-info div { margin-bottom: 8px; }
        .bill-info input { border: none; border-bottom: 1px solid #000; font-weight: bold; width: 120px; text-align: right; outline: none; }

        /* Address Grid */
        .grid-box { display: grid; grid-template-columns: 1fr 1fr; border: 2px solid #000; margin-bottom: 20px; }
        .address-area { padding: 12px; border-right: 2px solid #000; }
        .address-area:last-child { border-right: none; }
        .address-area label { display: block; background: #000; color: #fff; font-size: 11px; padding: 3px 10px; width: fit-content; margin-bottom: 8px; font-weight: bold; }
        .address-area textarea { width: 100%; border: none; font-size: 14px; outline: none; background: transparent; resize: none; font-weight: 500; font-family: inherit; }

        /* Professional Table - No HSN */
        table { width: 100%; border-collapse: collapse; border: 2px solid #000; }
        thead th { background: #000 !important; color: #fff !important; padding: 12px 10px; font-size: 12px; text-transform: uppercase; border: 1px solid #333; }
        tbody td { padding: 12px 10px; border: 1px solid #000; vertical-align: middle; font-size: 14px; font-weight: 600; }
        
        .item-row input { width: 100%; border: none; outline: none; font-size: 14px; font-weight: 600; background: transparent; }
        .center-text { text-align: center; }
        .right-text { text-align: right; padding-right: 15px; }

        /* Footer Alignment */
        .footer-grid { display: grid; grid-template-columns: 1.5fr 1fr; border: 2px solid #000; border-top: none; }
        .terms-box { padding: 15px; border-right: 2px solid #000; font-size: 11px; line-height: 1.4; }
        .terms-box strong { text-decoration: underline; display: block; margin-bottom: 5px; }
        
        .totals-column { background: var(--gray); }
        .total-row { display: flex; justify-content: space-between; padding: 10px 15px; border-bottom: 1px solid #ccc; font-size: 14px; font-weight: 700; }
        .net-total { background: #000 !important; color: #fff !important; font-size: 18px; padding: 15px; border: none; }

        /* Amount in Words - Exactly on Right Side */
        .words-wrap { border: 2px solid #000; border-top: none; padding: 15px; text-align: right; background: #fff; }
        .words-wrap span { font-size: 12px; font-weight: 800; text-transform: uppercase; color: #000; border-bottom: 1px solid #000; }

        /* Utility Buttons */
        .action-area { text-align: center; margin-top: 30px; display: flex; justify-content: center; gap: 20px; }
        .btn { padding: 15px 30px; border: none; cursor: pointer; font-weight: bold; text-transform: uppercase; border-radius: 5px; }
        .btn-add { background: #555; color: white; margin-top: 10px; }
        .btn-whatsapp { background: #25D366; color: white; font-size: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .del-btn { background: #ff4444; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer; font-weight: bold; }

        /* PDF & Print Logic - Hiding unwanted elements */
        @media print { 
            .no-print, .btn-add, .del-btn, .action-area { display: none !important; }
            body { background: white; padding: 0; }
            .bill-book { border: 2px solid #000; box-shadow: none; width: 100%; margin: 0; }
        }
    </style>
</head>
<body>

<div class="bill-book" id="invoice-sheet">
    <div class="tax-top">Tax Invoice | Original</div>
    
    <div class="header-main">
        <div class="shop-details">
            <h1>MUTHU MOBILES</h1>
            <p>Scoot Road, Meanakshi Bazar, Madurai, TN - 625001</p>
            <p>GSTIN: 33GQCPS0946B1Z2 | Ph: +91 8675007409</p>
        </div>
        <div class="bill-info">
            <div>Bill No: <input type="text" value="#2026-001"></div>
            <div>Date: <input type="date" id="today"></div>
        </div>
    </div>

    <div class="grid-box">
        <div class="address-area">
            <label>CUSTOMER DETAILS</label>
            <textarea placeholder="Enter Name, Address & Phone..." rows="3"></textarea>
        </div>
        <div class="address-area">
            <label>REMARKS / IMEI</label>
            <textarea placeholder="IMEI: 35XXXXXXXXXXXXX" rows="3"></textarea>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 50%;">Description of Goods</th>
                <th style="width: 10%;">Qty</th>
                <th style="width: 15%;">Rate</th>
                <th style="width: 20%; text-align: right;">Amount</th>
                <th class="no-print" style="width: 5%;"></th>
            </tr>
        </thead>
        <tbody id="bill-items">
            </tbody>
    </table>

    <div style="text-align: left;" class="no-print">
        <button class="btn-add" onclick="addRow()">+ Add New Row</button>
    </div>

    <div class="footer-grid">
        <div class="terms-box">
            <strong>TERMS & CONDITIONS:</strong>
            1. Goods once sold will not be taken back.<br>
            2. Warranty as per Company norms.<br>
            3. Subject to Madurai Jurisdiction.
        </div>
        <div class="totals-column">
            <div class="total-row"><span>Taxable Value:</span> <span id="taxable-amt">0.00</span></div>
            <div class="total-row"><span>CGST (9%):</span> <span id="cgst-amt">0.00</span></div>
            <div class="total-row"><span>SGST (9%):</span> <span id="sgst-amt">0.00</span></div>
            <div class="total-row net-total"><span>NET TOTAL:</span> <span id="grand-total">0.00</span></div>
        </div>
    </div>

    <div class="words-wrap">
        Amount in Words: <span id="words-display">ZERO RUPEES ONLY</span>
    </div>
</div>

<div class="action-area">
    <button class="btn btn-whatsapp" onclick="generateInvoice()">Share Bill on WhatsApp</button>
</div>

<script>
    document.getElementById('today').valueAsDate = new Date();

    function addRow() {
        const tbody = document.getElementById('bill-items');
        const tr = document.createElement('tr');
        tr.className = "item-row";
        tr.innerHTML = `
            <td><input type="text" class="p-name" placeholder="Mobile Model Name"></td>
            <td class="center-text"><input type="number" class="p-qty" value="1" oninput="calculate()"></td>
            <td class="center-text"><input type="number" class="p-rate" value="0" oninput="calculate()"></td>
            <td class="right-text" style="font-weight:bold;">₹<span class="p-total">0.00</span></td>
            <td class="no-print"><button class="del-btn" onclick="this.parentElement.parentElement.remove(); calculate();">✕</button></td>
        `;
        tbody.appendChild(tr);
    }

    function calculate() {
        let subtotal = 0;
        document.querySelectorAll('.item-row').forEach(row => {
            const q = row.querySelector('.p-qty').value || 0;
            const r = row.querySelector('.p-rate').value || 0;
            const line = q * r;
            row.querySelector('.p-total').innerText = line.toFixed(2);
            subtotal += line;
        });

        const taxable = subtotal / 1.18;
        const gst = subtotal - taxable;

        document.getElementById('taxable-amt').innerText = taxable.toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('cgst-amt').innerText = (gst/2).toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('sgst-amt').innerText = (gst/2).toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('grand-total').innerText = subtotal.toLocaleString('en-IN', {minimumFractionDigits: 2});
        
        document.getElementById('words-display').innerText = numberToWords(Math.round(subtotal)) + " RUPEES ONLY";
    }

    async function generateInvoice() {
        // Step 1: Save items to MongoDB
        const rows = document.querySelectorAll('.item-row');
        for (let row of rows) {
            const itemData = {
                name: row.querySelector('.p-name').value,
                price: row.querySelector('.p-rate').value,
                quantity: row.querySelector('.p-qty').value
            };
            if(itemData.name) {
                await fetch('/api/products/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(itemData)
                });
            }
        }

        // Step 2: Create PDF & Share
        const element = document.getElementById('invoice-sheet');
        const opt = {
            margin: 0.2,
            filename: 'MuthuMobiles_Bill.pdf',
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
        const file = new File([pdfBlob], "Muthu_Mobiles_Invoice.pdf", { type: "application/pdf" });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ files: [file], title: 'Invoice From Muthu Mobiles' });
        } else {
            html2pdf().set(opt).from(element).save();
        }
    }

    function numberToWords(num) {
        const a = ['','ONE ','TWO ','THREE ','FOUR ', 'FIVE ','SIX ','SEVEN ','EIGHT ','NINE ','TEN ','ELEVEN ','TWELVE ','THIRTEEN ','FOURTEEN ','FIFTEEN ','SIXTEEN ','SEVENTEEN ','EIGHTEEN ','NINETEEN '];
        const b = ['', '', 'TWENTY','THIRTY','FORTY','FIFTY', 'SIXTY','SEVENTY','EIGHTY','NINETY'];
        const n = ('0000000' + num).substr(-7).match(/^(\d{2})(\d{2})(\d{2})(\d{1})$/);
        if (!n) return ''; 
        let str = '';
        str += (Number(n[1]) != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'LAKH ' : '';
        str += (Number(n[2]) != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'THOUSAND ' : '';
        str += (Number(n[3]) != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'HUNDRED ' : '';
        str += (Number(n[4]) != 0) ? ((str != '') ? 'AND ' : '') + (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) : '';
        return str.trim();
    }

    addRow(); // Start with one item
</script>
</body>
</html>