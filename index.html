<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUTHU MOBILES | Digital Billing</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        :root { --red: #b22222; --green: #25D366; --dark: #333; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; padding: 10px; }
        .invoice-card { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .header { display: flex; justify-content: space-between; border-bottom: 4px solid var(--red); padding-bottom: 10px; margin-bottom: 20px; }
        .brand h1 { color: var(--red); margin: 0; font-size: 28px; }
        .brand-sub { font-size: 11px; color: #666; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .box h4 { margin: 0 0 5px 0; font-size: 12px; color: var(--red); }
        input, textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th { background: var(--dark); color: white; padding: 10px; font-size: 12px; text-align: left; }
        td { padding: 8px; border-bottom: 1px solid #eee; }
        .footer-area { display: flex; justify-content: space-between; margin-top: 20px; }
        .totals { width: 40%; background: #fff8f8; padding: 15px; border-radius: 5px; }
        .total-row { display: flex; justify-content: space-between; margin-bottom: 5px; font-size: 14px; }
        .grand-total { font-size: 18px; font-weight: bold; color: var(--red); border-top: 1px solid var(--red); padding-top: 10px; }
        .actions { text-align: center; margin-top: 30px; }
        .btn { padding: 15px; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; color: white; width: 100%; font-size: 16px; }
        .btn-add { background: var(--dark); margin-bottom: 20px; }
        .btn-share { background: var(--green); }
        @media print { .no-print { display: none !important; } }
    </style>
</head>
<body>

<div class="invoice-card" id="bill-area">
    <div class="header">
        <div class="brand">
            <h1>MUTHU MOBILES</h1>
            <div class="brand-sub">
                Meenakshi bazar, Madurai | Mob: 8675007409<br>
                GSTIN: 33GQCPS0946B1Z2
            </div>
        </div>
        <div style="text-align: right; font-size: 12px;">
            Date: <input type="date" id="invDate" style="width: auto; border:none;"><br>
            Inv: <input type="text" id="invNo" value="#001" style="width: 50px; border:none; font-weight:bold;">
        </div>
    </div>

    <div class="grid">
        <div class="box">
            <h4>CUSTOMER DETAILS</h4>
            <input type="text" id="custName" placeholder="Name & Phone">
        </div>
        <div class="box">
            <h4>REMARKS</h4>
            <input type="text" id="notes" placeholder="IMEI / Model Name">
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 50%;">ITEM</th>
                <th style="width: 15%;">QTY</th>
                <th style="width: 15%;">RATE (Incl)</th>
                <th style="width: 20%; text-align: right;">TOTAL</th>
            </tr>
        </thead>
        <tbody id="billBody"></tbody>
    </table>
    
    <button class="btn btn-add no-print" onclick="addRow()">+ Add New Item</button>

    <div class="footer-area">
        <div style="font-size: 10px; color: #999; width: 50%;">
            * Prices inclusive of 18% GST.<br>
            * Computer generated bill.
        </div>
        <div class="totals">
            <div class="total-row"><span>Taxable Value:</span> <span id="taxableAmt">â‚¹0.00</span></div>
            <div class="total-row"><span>GST (18%):</span> <span id="gstAmt">â‚¹0.00</span></div>
            <div class="total-row grand-total"><span>Net Amount:</span> <span id="grandTotal">â‚¹0.00</span></div>
        </div>
    </div>
</div>

<div class="actions no-print">
    <button class="btn btn-share" onclick="saveAndShare()">ðŸ“¤ GENERATE BILL & SHARE ON WHATSAPP</button>
</div>

<script>
    document.getElementById('invDate').valueAsDate = new Date();

    function addRow() {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="text" class="p-name" placeholder="Item Name"></td>
            <td><input type="number" class="p-qty" value="1" oninput="calculate()"></td>
            <td><input type="number" class="p-rate" value="0" oninput="calculate()"></td>
            <td style="text-align: right;">â‚¹<span class="p-line-total">0.00</span></td>
        `;
        document.getElementById('billBody').appendChild(tr);
    }

    function calculate() {
        let total = 0;
        document.querySelectorAll('#billBody tr').forEach(row => {
            const q = Number(row.querySelector('.p-qty').value) || 0;
            const r = Number(row.querySelector('.p-rate').value) || 0;
            const line = q * r;
            row.querySelector('.p-line-total').innerText = line.toFixed(2);
            total += line;
        });
        const taxable = total / 1.18;
        const gst = total - taxable;
        document.getElementById('taxableAmt').innerText = "â‚¹" + taxable.toFixed(2);
        document.getElementById('gstAmt').innerText = "â‚¹" + gst.toFixed(2);
        document.getElementById('grandTotal').innerText = "â‚¹" + total.toFixed(2);
    }

    // Auto-Save to MongoDB Function
    async function autoSaveData() {
        const rows = document.querySelectorAll('#billBody tr');
        for (let row of rows) {
            const item = {
                name: row.querySelector('.p-name').value,
                price: row.querySelector('.p-rate').value,
                quantity: row.querySelector('.p-qty').value
            };
            if(item.name && item.price > 0) {
                await fetch('/api/products/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item)
                });
            }
        }
        console.log("Data saved to Cloud.");
    }

    async function saveAndShare() {
        // 1. First Auto-save to Cloud
        await autoSaveData();

        // 2. Prepare PDF
        const element = document.getElementById('bill-area');
        const opt = {
            margin: 0.3,
            filename: 'Muthu_Bill.pdf',
            image: { type: 'jpeg', quality: 0.98 },
            html2canvas: { scale: 3 },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        try {
            const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
            const file = new File([pdfBlob], "Muthu_Mobiles_Bill.pdf", { type: "application/pdf" });

            if (navigator.canShare && navigator.canShare({ files: [file] })) {
                await navigator.share({
                    files: [file],
                    title: 'Muthu Mobiles Bill',
                });
            } else {
                html2pdf().set(opt).from(element).save();
                alert("Bill Saved to Cloud & PDF Downloaded!");
            }
        } catch (err) {
            alert("Error in sharing. PDF downloaded instead.");
            html2pdf().set(opt).from(element).save();
        }
    }

    addRow();
</script>
</body>
</html>