<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUTHU MOBILES | Premium Tax Invoice</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --brand-red: #D32F2F; --deep-black: #1A1A1A; --soft-gray: #F8F9FA; --border-bold: #222; }
        body { font-family: 'Inter', 'Segoe UI', Arial, sans-serif; background: #e0e4e8; margin: 0; padding: 15px; color: #222; }
        
        .invoice-card { 
            max-width: 850px; margin: auto; background: white; padding: 40px; 
            border: 2px solid var(--border-bold); box-shadow: 0 10px 30px rgba(0,0,0,0.15); 
            position: relative; border-radius: 2px;
        }

        /* Top Header Section */
        .tax-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 25px; border-bottom: 5px solid var(--brand-red); padding-bottom: 15px; }
        .brand-logo h1 { margin: 0; font-size: 36px; font-weight: 900; color: var(--brand-red); letter-spacing: -1px; }
        .brand-logo p { margin: 3px 0; font-size: 12px; font-weight: 600; line-height: 1.4; color: #444; }
        .invoice-meta { text-align: right; font-size: 13px; font-weight: bold; }
        .meta-field { margin-bottom: 8px; }
        .meta-field input { border: none; border-bottom: 1px solid #ccc; padding: 2px 5px; font-weight: bold; font-family: inherit; width: 100px; outline: none; text-align: right; }

        /* Address Grid */
        .address-container { display: grid; grid-template-columns: 1fr 1fr; border: 1.5px solid var(--border-bold); margin-bottom: 20px; }
        .address-box { padding: 12px; border-right: 1.5px solid var(--border-bold); }
        .address-box:last-child { border-right: none; }
        .address-box h4 { margin: 0 0 10px 0; font-size: 12px; text-transform: uppercase; background: var(--deep-black); color: white; padding: 5px 10px; display: inline-block; }
        .address-box textarea { width: 100%; border: none; font-size: 13px; font-weight: 500; outline: none; background: transparent; resize: none; font-family: inherit; }

        /* Table Design */
        table { width: 100%; border-collapse: collapse; border: 1.5px solid var(--border-bold); }
        thead th { background: var(--deep-black); color: white; padding: 12px 10px; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; border: 1px solid #444; text-align: left; }
        tbody td { padding: 10px; border: 1px solid #ddd; vertical-align: middle; font-size: 14px; }
        .item-row input { width: 100%; border: none; font-size: 14px; font-weight: 600; outline: none; padding: 5px; }
        .qty-rate input { text-align: center; }

        /* Footer Layout */
        .bottom-grid { display: grid; grid-template-columns: 1.5fr 1fr; border: 1.5px solid var(--border-bold); border-top: none; }
        .terms-section { padding: 20px; border-right: 1.5px solid var(--border-bold); font-size: 11px; color: #555; }
        .terms-section h5 { margin: 0 0 8px 0; color: #000; font-size: 12px; text-decoration: underline; }
        
        .totals-section { background: var(--soft-gray); }
        .calc-row { display: flex; justify-content: space-between; padding: 10px 20px; border-bottom: 1px solid #ddd; font-size: 13px; font-weight: 600; }
        .grand-total-row { background: var(--deep-black); color: white; padding: 15px 20px; font-size: 18px; font-weight: 900; }

        /* Amount in Words - Alignment Fixed to Left */
        .words-container { border: 1.5px solid var(--border-bold); border-top: none; padding: 15px 20px; text-align: left; background: #fff; display: flex; align-items: center; }
        .words-container strong { font-size: 12px; margin-right: 10px; color: var(--brand-red); text-transform: uppercase; }
        #wordAmt { font-size: 13px; font-weight: 800; color: var(--deep-black); text-transform: uppercase; }

        /* Actions */
        .no-print { text-align: center; margin-top: 35px; display: flex; justify-content: center; gap: 20px; }
        .btn { padding: 16px 35px; border: none; border-radius: 4px; cursor: pointer; font-weight: 800; font-size: 16px; transition: 0.2s transform; text-transform: uppercase; }
        .btn-add { background: #555; color: white; margin-bottom: 15px; }
        .btn-share { background: #25D366; color: white; box-shadow: 0 5px 15px rgba(37,211,102,0.4); }
        .btn-share:hover { transform: translateY(-2px); }
        
        /* Delete Button Alignment */
        .del-btn { background: #ff4444; color: white; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; font-weight: bold; display: flex; align-items: center; justify-content: center; margin: auto; transition: 0.2s; }
        .del-btn:hover { background: #cc0000; }

        @media print { .no-print, .del-btn { display: none !important; } body { padding: 0; } .invoice-card { box-shadow: none; border: 2px solid #000; } }
    </style>
</head>
<body>

<div class="invoice-card" id="capture-area">
    <div style="text-align: center; font-size: 9px; font-weight: bold; margin-bottom: 5px; color: #777;">TAX INVOICE | ORIGINAL FOR RECIPIENT</div>
    
    <div class="tax-header">
        <div class="brand-logo">
            <h1>MUTHU MOBILES</h1>
            <p>Scoot Road, Meanakshi Bazar, Madurai, Tamil Nadu, 625001</p>
            <p>GSTIN: 33GQCPS0946B1Z2 | Ph: +91 8675007409</p>
        </div>
        <div class="invoice-meta">
            <div class="meta-field">Inv No: <input type="text" value="#2026-001"></div>
            <div class="meta-field">Date: <input type="date" id="billDate"></div>
        </div>
    </div>

    <div class="address-container">
        <div class="address-box">
            <h4>Billing Address</h4>
            <textarea placeholder="Enter Customer Name & Address..." rows="3"></textarea>
        </div>
        <div class="address-box">
            <h4>Remarks / IMEI</h4>
            <textarea placeholder="IMEI No: 35XXXXXXXXXXXXX" rows="3"></textarea>
        </div>
    </div>

    <table>
        <thead>
            <tr>
                <th style="width: 45%;">Description of Goods</th>
                <th style="width: 10%; text-align: center;">Qty</th>
                <th style="width: 15%; text-align: center;">Rate (Incl)</th>
                <th style="width: 20%; text-align: right;">Amount (₹)</th>
                <th class="no-print" style="width: 10%; text-align: center;">Action</th>
            </tr>
        </thead>
        <tbody id="items-list"></tbody>
    </table>

    <div class="no-print" style="margin-top: 15px;">
        <button class="btn btn-add" onclick="addNewRow()">+ Add New Item</button>
    </div>

    <div class="bottom-grid">
        <div class="terms-section">
            <h5>Terms & Conditions:</h5>
            <p>1. Goods once sold will not be taken back or exchanged.</p>
            <p>2. Warranty as per manufacturer's policy only.</p>
            <p>3. All disputes are subject to Madurai jurisdiction.</p>
            <p style="margin-top:15px; font-weight:bold;">For MUTHU MOBILES</p>
            <br><br>
            <p>Authorized Signatory</p>
        </div>
        <div class="totals-section">
            <div class="calc-row"><span>Taxable Value:</span> <span id="taxable">₹0.00</span></div>
            <div class="calc-row"><span>CGST @9%:</span> <span id="cgst">₹0.00</span></div>
            <div class="calc-row"><span>SGST @9%:</span> <span id="sgst">₹0.00</span></div>
            <div class="calc-row grand-total-row"><span>TOTAL:</span> <span id="grand">₹0.00</span></div>
        </div>
    </div>
    <div class="words-container">
        <strong>Amount in Words:</strong> <span id="wordAmt">ZERO RUPEES ONLY</span>
    </div>
</div>

<div class="no-print">
    <button class="btn btn-share" onclick="finalizeBill()">Generate & Share on WhatsApp</button>
</div>

<script>
    document.getElementById('billDate').valueAsDate = new Date();

    function addNewRow() {
        const tbody = document.getElementById('items-list');
        const row = document.createElement('tr');
        row.innerHTML = `
            <td><input type="text" class="p-name" placeholder="Item Name / Model"></td>
            <td class="qty-rate"><input type="number" class="p-qty" value="1" oninput="runCalc()"></td>
            <td class="qty-rate"><input type="number" class="p-rate" value="0" oninput="runCalc()"></td>
            <td style="text-align: right; font-weight: 800;">₹<span class="p-total">0.00</span></td>
            <td class="no-print"><button class="del-btn" onclick="this.parentElement.parentElement.remove(); runCalc();">✕</button></td>
        `;
        tbody.appendChild(row);
    }

    function runCalc() {
        let grandTotal = 0;
        document.querySelectorAll('#items-list tr').forEach(row => {
            const qty = Number(row.querySelector('.p-qty').value) || 0;
            const rate = Number(row.querySelector('.p-rate').value) || 0;
            const lineTotal = qty * rate;
            row.querySelector('.p-total').innerText = lineTotal.toLocaleString('en-IN', {minimumFractionDigits: 2});
            grandTotal += lineTotal;
        });

        const taxableValue = grandTotal / 1.18;
        const totalTax = grandTotal - taxableValue;

        document.getElementById('taxable').innerText = "₹" + taxableValue.toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('cgst').innerText = "₹" + (totalTax/2).toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('sgst').innerText = "₹" + (totalTax/2).toLocaleString('en-IN', {minimumFractionDigits: 2});
        document.getElementById('grand').innerText = "₹" + grandTotal.toLocaleString('en-IN', {minimumFractionDigits: 2});
        
        document.getElementById('wordAmt').innerText = toWords(Math.round(grandTotal)) + " RUPEES ONLY";
    }

    async function finalizeBill() {
        // Auto-save to MongoDB first
        const items = [];
        document.querySelectorAll('#items-list tr').forEach(row => {
            items.push({
                name: row.querySelector('.p-name').value,
                price: row.querySelector('.p-rate').value,
                quantity: row.querySelector('.p-qty').value
            });
        });

        for(let item of items) {
            if(item.name && item.price > 0) {
                await fetch('/api/products/add', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(item)
                });
            }
        }

        // Generate and Share PDF
        const element = document.getElementById('capture-area');
        const opt = {
            margin: 0.3,
            filename: 'MuthuMobiles_Bill.pdf',
            image: { type: 'jpeg', quality: 1 },
            html2canvas: { scale: 3, useCORS: true },
            jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
        };

        const pdfBlob = await html2pdf().set(opt).from(element).output('blob');
        const file = new File([pdfBlob], "Muthu_Mobiles_Bill.pdf", { type: "application/pdf" });

        if (navigator.canShare && navigator.canShare({ files: [file] })) {
            await navigator.share({ files: [file], title: 'Invoice: Muthu Mobiles' });
        } else {
            html2pdf().set(opt).from(element).save();
        }
    }

    function toWords(num) {
        const a = ['','One ','Two ','Three ','Four ', 'Five ','Six ','Seven ','Eight ','Nine ','Ten ','Eleven ','Twelve ','Thirteen ','Fourteen ','Fifteen ','Sixteen ','Seventeen ','Eighteen ','Nineteen '];
        const b = ['', '', 'Twenty','Thirty','Forty','Fifty', 'Sixty','Seventy','Eighty','Ninety'];
        const n = ('0000000' + num).substr(-7).match(/^(\d{2})(\d{2})(\d{2})(\d{1})$/);
        if (!n) return ''; 
        let str = '';
        str += (Number(n[1]) != 0) ? (a[Number(n[1])] || b[n[1][0]] + ' ' + a[n[1][1]]) + 'Lakh ' : '';
        str += (Number(n[2]) != 0) ? (a[Number(n[2])] || b[n[2][0]] + ' ' + a[n[2][1]]) + 'Thousand ' : '';
        str += (Number(n[3]) != 0) ? (a[Number(n[3])] || b[n[3][0]] + ' ' + a[n[3][1]]) + 'Hundred ' : '';
        str += (Number(n[4]) != 0) ? ((str != '') ? 'and ' : '') + (a[Number(n[4])] || b[n[4][0]] + ' ' + a[n[4][1]]) : '';
        return str.trim();
    }

    addNewRow();
</script>
</body>
</html>